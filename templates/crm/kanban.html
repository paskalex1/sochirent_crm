{% extends "base.html" %}

{% block title %}Канбан — {{ pipeline.name }}{% endblock %}

{% block extra_head %}
  <style>
    .kanban-board {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    }

    .kanban-column {
      background: #fff;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
    }

    .kanban-column h3 {
      font-size: 14px;
      margin: 0 0 10px;
      color: #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .kanban-counter {
      font-size: 12px;
      color: #666;
    }

    .kanban-list {
      min-height: 40px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .kanban-card {
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 10px;
      cursor: grab;
    }

    .kanban-card:active {
      cursor: grabbing;
    }

    .kanban-card h4 {
      font-size: 14px;
      margin: 0 0 6px;
      color: #111;
    }

    .kanban-muted {
      font-size: 12px;
      color: #777;
    }

    .drop-hover {
      outline: 2px dashed #28a745;
      outline-offset: 2px;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Канбан — {{ pipeline.name }}</h1>
  </div>

  <div class="kanban-board">
    {% for stage in stages %}
      <section class="kanban-column" data-stage-id="{{ stage.id }}">
        <h3>
          <span>{{ stage.name }}</span>
          <span class="badge bg-secondary kanban-counter">{{ stage.deals.count }}</span>
        </h3>
        <div
          class="kanban-list"
          ondragover="onDragOver(event)"
          ondrop="onDrop(event, {{ stage.id }})"
        >
          {% for deal in stage.deals.all %}
            <article
              class="kanban-card"
              draggable="true"
              ondragstart="onDragStart(event, {{ deal.id }})"
              data-deal-id="{{ deal.id }}"
            >
              <h4>{{ deal.title }}</h4>
              <div class="kanban-muted">
                Лид: {{ deal.lead.full_name|default:deal.lead.phone }}
                {% if deal.value %} • Сумма: {{ deal.value }}{% endif %}
              </div>
            </article>
          {% empty %}
            <div class="kanban-muted">Нет сделок</div>
          {% endfor %}
        </div>
      </section>
    {% endfor %}
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(";").shift();
    }

    const csrftoken = getCookie("csrftoken");
    let draggedDealId = null;

    function onDragStart(ev, dealId) {
      draggedDealId = dealId;
      ev.dataTransfer.effectAllowed = "move";
      ev.dataTransfer.setData("text/plain", String(dealId));
    }

    function onDragOver(ev) {
      ev.preventDefault();
      const list = ev.currentTarget;
      list.classList.add("drop-hover");
    }

    function onDrop(ev, stageId) {
      ev.preventDefault();
      ev.currentTarget.classList.remove("drop-hover");

      const dealId =
        draggedDealId || Number(ev.dataTransfer.getData("text/plain"));
      if (!dealId) return;

      const card = document.querySelector(
        `.kanban-card[data-deal-id=\"${dealId}\"]`
      );
      if (card) ev.currentTarget.appendChild(card);

      document.querySelectorAll(".kanban-column").forEach((col) => {
        const count = col.querySelectorAll(".kanban-list .kanban-card").length;
        const counter = col.querySelector(".kanban-counter");
        if (counter) counter.textContent = count;
      });

      fetch(`/crm/deal/${dealId}/move/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
        },
        body: new URLSearchParams({ stage_id: stageId }),
      })
        .then((res) => {
          if (!res.ok) throw new Error("Move failed");
        })
        .catch((err) => {
          alert("Не удалось переместить: " + err.message);
        });
    }
  </script>
{% endblock %}
